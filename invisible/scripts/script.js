var Color;Color={number:function(r,o,n){var t;return t=Phaser.Color.HSLtoRGB(r,o,n),t.r<<16|t.g<<8|t.b},string:function(r,o,n){var t;return t=Phaser.Color.HSLtoRGB(r,o,n),Phaser.Color.RGBtoString(t.r,t.g,t.b)}};
var Effect1,Effect2,Effect3,Effect4,Effect5;Effect1=function(){function e(e){this.root=e,this.game=this.root.game,this.effect=this.game.add.graphics().lineStyle(4,16777215,.5).drawRect(SquareSize/-2,SquareSize/-2,SquareSize,SquareSize),this.effect.visible=!1}return e.prototype.begin=function(e){var t;return this.index=e,this.effect.visible=!0,this.game.world.addChild(this.effect),this.root.hp.chara.position.set((this.index-3.5)*SquareSize,-87),this.effect.alpha=0,this.effect.position.set(SquareX+(this.index+.5)*SquareSize,SquareY+2.5*SquareSize),this.game.add.tween(this.effect).to({alpha:1},350,Phaser.Easing.Default,!0,0,0,!0),t=this.game.add.tween(this.effect).to({y:SquareY+.5*SquareSize},700,Phaser.Easing.Default,!0),t.onComplete.addOnce(function(){return this.effect.visible=!1},this)},e}(),Effect2=function(){function e(e){this.root=e,this.game=this.root.game,this.effect=this.game.add.graphics().lineStyle(4,16777215,.5).drawRect(SquareSize/-2,SquareSize/-2,SquareSize,SquareSize),this.effect.visible=!1,this.effect.scale.set(3,3)}return e.prototype.begin=function(){var e;return this.effect.visible=!0,this.game.world.addChild(this.effect),this.effect.alpha=0,this.effect.position.set(SquareX+1.5*SquareSize,SquareY+SquareHeight/2),this.root.hp.chara.position.y=-87,this.game.add.tween(this.effect).to({alpha:1},350,Phaser.Easing.Default,!0,0,0,!0),e=this.game.add.tween(this.effect).to({x:SquareX+6.5*SquareSize},700,Phaser.Easing.Default,!0),e.onComplete.addOnce(function(){return this.effect.visible=!1},this)},e}(),Effect3=function(){function e(e){this.root=e,this.game=this.root.game,this.effect=this.game.add.graphics().lineStyle(4,16777215,.5).drawRect(SquareSize/-2,SquareSize/-2,SquareSize,SquareSize),this.effect.visible=!1}return e.prototype.begin=function(e){var t;return this.index=e,this.effect.visible=!0,this.game.world.addChild(this.effect),this.root.hp.chara.position.set((this.index-3.5)*SquareSize,-87),this.effect.alpha=0,this.effect.position.set(SquareX+(this.index+.5)*SquareSize,SquareY+2.5*SquareSize),this.game.add.tween(this.effect).to({alpha:1},200,Phaser.Easing.Default,!0),this.effect.scale.set(2,2),t=this.game.add.tween(this.effect.scale).to({x:1,y:1},700,Phaser.Easing.Default,!0),this.effect.angle=0,this.game.add.tween(this.effect).to({angle:180},700,Phaser.Easing.Default,!0),t.onComplete.addOnce(function(){return this.effect.visible=!1},this)},e}(),Effect4=function(){function e(e){this.root=e,this.game=this.root.game,this.effect=this.game.add.graphics().lineStyle(4,16777215,.5).drawRect(SquareSize/-2,SquareSize/-2,SquareSize,SquareSize),this.effect.visible=!1}return e.prototype.begin=function(e){var t;return this.index=e,this.effect.visible=!0,this.game.world.addChild(this.effect),this.root.hp.chara.position.set((this.index-3)*SquareSize,-87),this.effect.alpha=0,this.effect.position.set(SquareX+(this.index+1)*SquareSize,SquareY+2*SquareSize),this.game.add.tween(this.effect).to({alpha:1},200,Phaser.Easing.Default,!0),this.effect.scale.set(3,3),t=this.game.add.tween(this.effect.scale).to({x:2,y:2},700,Phaser.Easing.Default,!0),this.effect.angle=0,this.game.add.tween(this.effect).to({angle:180},700,Phaser.Easing.Default,!0),t.onComplete.addOnce(function(){return this.effect.visible=!1},this)},e}(),Effect5=function(){function e(e){this.root=e,this.game=this.root.game,this.effect=this.game.add.graphics().lineStyle(4,16777215,.5).drawRect(SquareSize/-2,SquareSize/-2,SquareSize,SquareSize),this.effect.visible=!1}return e.prototype.begin=function(e){var t;return this.index=e,this.effect.visible=!0,this.game.world.addChild(this.effect),this.root.hp.chara.position.set((this.index-3.5)*SquareSize,-87),this.effect.alpha=0,this.effect.position.set(SquareX+(this.index+.5)*SquareSize,SquareY+2.5*SquareSize),this.game.add.tween(this.effect).to({alpha:1},200,Phaser.Easing.Default,!0),this.effect.angle=0,t=this.game.add.tween(this.effect).to({angle:270},700,Phaser.Easing.Default,!0),this.game.add.tween(this.effect).to({y:SquareY+.5*SquareSize},350,Phaser.Easing.Default,!0,0,0,!0),t.onComplete.addOnce(function(){return this.effect.visible=!1},this)},e}();
var Hp;Hp=function(){function t(t){var i;this.root=t,this.game=this.root.game,this.hp=new Limited,this.hp.setMax(200),this.Width=200,this.container=this.game.add.sprite(SquareX+SquareWidth/2,3*GameHeight/4+SquareSize*(SquareLine+2)/4),this.game.physics.arcade.enable(this.container),this.container.addChild(this.game.add.graphics()).beginFill(16777215).drawRect(this.Width/-2-1,-8,this.Width+2,16),i=this.game.add.text(this.Width/-2-66,3,"HP",{fill:"#fff",font:"18px Gennokaku"}),i.anchor.y=.5,this.container.addChild(i),this.text=this.game.add.text(this.Width/-2-8,3,"",{fill:"#fff",font:"18px Gennokaku"}),this.text.anchor.set(1,.5),this.container.addChild(this.text),this.bar=this.game.add.graphics(this.Width/-2,-7).beginFill(Color.number(.3,.5,.5)).drawRect(0,0,this.Width,14),this.bar.width=0,this.container.addChild(this.bar),this.chara=this.game.add.sprite(0,0,"chara"),this.chara.anchor.x=.5,this.container.addChild(this.chara),this.chara.animations.add("walk",[9,10,11,10],2,!0).play()}return t.prototype.init=function(){return this.hp.maximize(),this.draw()},t.prototype.draw=function(){var t,i,h;return h=Math.ceil(this.Width*(this.hp.now-this.hp.min)/(this.hp.max-this.hp.min)),h!==this.bar.width?(i=this.game.add.tween(this.bar).to({width:h},1500*Math.abs(h-this.bar.width)/this.Width,Phaser.Easing.Default,!0),t=0,i.onUpdateCallback(function(){return++t,t%3?void 0:this.text.text=Math.ceil(this.hp.max*this.bar.width/this.Width).toString()},this),i.onComplete.addOnce(function(){return this.text.text=this.hp.now.toString()},this)):void 0},t.prototype.damage=function(t,i){var h,a,e,n;for(e=t.position.clone(),a=t.parent;a;)e.add(a.x,a.y),a=a.parent;return h=(180*this.game.math.angleBetweenPoints(e,this.container)/Math.PI+90)%360,h=180>h?h:h-360,n=this.game.add.tween(t).to({angle:h},3*Math.abs(h),Phaser.Easing.Default,!0,i),n.onComplete.addOnce(function(){return Phaser.Point.subtract(this.container,e,t.body.velocity),t.body.velocity.setMagnitude(200)},this)},t.prototype.heal=function(){return this.hp.now?(this.hp.setNow(this.hp.now+10),this.draw()):void 0},t.prototype.begin=function(t){return this.enemys=t,this.root.state.set(this)},t.prototype.end=function(){return this.root.state.set(null)},t.prototype.update=function(){return this.game.physics.arcade.overlap(this.container,this.enemys,function(t,i){return i.owner.attacked?void 0:(i.owner.attacked=!0,this.hp.setNow(this.hp.now-i.owner.power),this.draw(),this.game.sound.play("damage"))},null,this)},t}();
var Keys;Keys=function(){function t(t){var e,s,r,n;for(this.Keys=["up","down","left","right","z","x"],n=this.Keys,s=0,r=n.length;r>s;s++)e=n[s],this[e]=t.addKey(Phaser.Keyboard[e.toUpperCase()])}return t.prototype.update=function(){var t,e,s,r,n;for(r=this.Keys,n=[],e=0,s=r.length;s>e;e++)t=r[e],n.push(this[t+"JustDown"]=this[t].justDown);return n},t}();
var Limited;Limited=function(){function t(){this.max=100,this.maxMax=999,this.min=0,this.now=100}return t.prototype.setNow=function(t){return this.now=Math.min(Math.max(this.min,t),this.max)},t.prototype.setMin=function(t){return this.min=t,this.setMax(this.max)},t.prototype.setMax=function(t){return this.max=Math.min(Math.max(this.min,t),this.maxMax),this.setNow(this.now)},t.prototype.setMaxMax=function(t){return this.maxMax=t,this.setMax(this.max)},t.prototype.isMin=function(){return this.now===this.min},t.prototype.isMax=function(){return this.now===this.max},t.prototype.maximize=function(){return this.now=this.max},t}();
var Option,__modulo=function(t,i){return(+t%(i=+i)+i)%i};Option=function(){function t(t){var i,e,s;this.root=t,this.game=this.root.game,this.container=this.game.add.sprite(),this.container.visible=!1,this.selected=this.game.add.graphics(3*GameWidth/8-200).beginFill(16777215,.7).drawPolygon(-8,6,-8,LineHeight-6,-20,LineHeight/2).drawPolygon(208,6,208,LineHeight-6,220,LineHeight/2).beginFill(16777215,.3).lineStyle(1,16777215).drawRect(0,0,199,LineHeight-1),this.container.addChild(this.selected),this.game.add.tween(this.selected).to({alpha:.4},750,Phaser.Easing.Default,!0,0,-1,!0),this.texts=function(){var t,n,o,h;for(o=["OPTION","SOUND","TIMER","BACK"],h=[],i=t=0,n=o.length;n>t;i=++t)e=o[i],s=this.game.add.text(3*GameWidth/8-192,(i-.5)*LineHeight+5*GameHeight/8+3,e,{fill:"#fff",font:"18px Gennokaku"}),s.anchor.y=.5,this.container.addChild(s),i>0&&3>i?(s=this.game.add.text(3*GameWidth/8-8,(i-.5)*LineHeight+5*GameHeight/8+3,"",{fill:"#fff",font:"18px Gennokaku"}),s.anchor.set(1,.5),this.container.addChild(s),h.push(s)):h.push(null);return h}.call(this),this.texts=this.texts.slice(1,3),this.sound=localStorage.getItem("sound"),null==this.sound&&(this.sound=100),this.sound|=0,this.timer=localStorage.getItem("timer"),this.timer="true"===this.timer?!0:!1}return t.prototype.draw=function(){return this.selected.y=this.index*LineHeight+5*GameHeight/8,this.texts[0].text=this.sound+"%",this.texts[1].text=this.timer?"VISIBLE":"INVISIBLE"},t.prototype.begin=function(t){return this.title=t,this.index=0,this.game.world.addChild(this.container),this.container.visible=!0,this.container.x=GameWidth/-2,this.game.add.tween(this.container).to({x:0},500,Phaser.Easing.Quadratic.Out,!0),this.draw(),this.root.state.set(this)},t.prototype.end=function(){return this.game.add.tween(this.container).to({x:-GameWidth},500,Phaser.Easing.Quadratic.In,!0),this.title.selected.visible=!0,this.root.state.set(this.title),this.game.sound.play("ok",this.root.option.sound/100)},t.prototype.update=function(t){var i,e;if(e=t.downJustDown-t.upJustDown,i=t.rightJustDown-t.leftJustDown,e)return this.index=__modulo(this.index+e,3),this.draw(),this.game.sound.play("ok",this.root.option.sound/100);if(i){if(0===this.index)return this.sound=Math.min(Math.max(0,this.sound+5*i),100),localStorage.setItem("sound",this.sound),this.draw(),this.game.sound.play("ok",this.root.option.sound/100);if(1===this.index)return this.timer=!this.timer,localStorage.setItem("timer",this.timer),this.draw(),this.game.sound.play("ok",this.root.option.sound/100)}else if(t.zJustDown){if(1===this.index)return this.timer=!this.timer,localStorage.setItem("timer",this.timer),this.draw(),this.game.sound.play("ok",this.root.option.sound/100);if(2===this.index)return this.end()}else if(t.xJustDown)return this.end()},t}();
var Result,__modulo=function(t,e){return(+t%(e=+e)+e)%e};Result=function(){function t(t,e){var i,n,o,s,a,h,r,d,u;for(this.root=t,this.win=e,this.game=this.root.game,this.index=0,this.root.timer.stop(this.win||this.root.option.timer),i=new Date,this.name=[i.getMonth()+1,i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()].reduce(function(t,e){return t+("0"+e).slice(-2)},"ig"+i.getFullYear())+".png",this.container=this.game.add.graphics(SquareX+SquareWidth/2-200,SquareY+SquareHeight/2-160).beginFill(Color.number(.5,.2,.5)).lineStyle(2,Color.number(.5,.2,.2)).drawRect(0,0,400,320),this.selected=this.game.add.graphics(100,0).beginFill(0,.3).lineStyle(1,0).drawRect(0,0,199,LineHeight-1),this.container.addChild(this.selected),this.game.add.tween(this.selected).to({alpha:.4},750,Phaser.Easing.Default,!0,0,-1,!0),a=this.root.tips.increment(),this.container.addChild(this.game.add.text(16,284,a[0]+(1===a.length?"":"..."),{fill:"#fff",font:"18px Gennokaku"})),this.state=2,this.win?(this.game.sound.play("bird",this.root.option.sound/100).fadeOut(3e3),s=this.game.add.text(200,16,"GAME CLEAR !!",{fill:"#fff",font:"48px Gennokaku"}),s.anchor.x=.5,this.container.addChild(s),s=this.game.add.text(200,64,"Thank you for playing",{fill:"#fff",font:"24px Gennokaku"}),s.anchor.x=.5,this.container.addChild(s),this.container.alpha=0,this.container.y+=8,h=this.game.add.tween(this.container).to({alpha:1,y:this.container.y-8},500,Phaser.Easing.Default,!0),this.root.state.set(this)):(this.game.sound.play("over",.8*this.root.option.sound/100),s=this.game.add.text(200,16,"GAME OVER",{fill:"#fff",font:"48px Gennokaku"}),s.anchor.x=.5,this.container.addChild(s),this.container.alpha=0,this.container.y+=8,h=this.game.add.tween(this.container).to({alpha:1,y:this.container.y-8},500,Phaser.Easing.Default,!0),this.root.state.set(this)),this.win?$("#tweet").attr("href",this.tweet(this.root.timer.text.text+" でクリアしました。")):$("#tweet").attr("href",this.tweet("あと "+this.root.turn.t+" ターンのところでやられました。")),h.onComplete.addOnce(function(){return $("#tweet").show()}),u=["タイトルに戻る","リトライする","画像を保存する"],n=r=0,d=u.length;d>r;n=++r)o=u[n],s=this.game.add.text(108,n*LineHeight+142,o,{fill:"#fff",font:"18px Gennokaku"}),s.anchor.y=.5,this.container.addChild(s);this.draw()}return t.prototype.draw=function(){return this.selected.y=this.index*LineHeight+124},t.prototype.tweet=function(t){return"https://twitter.com/intent/tweet?text="+encodeURIComponent(t+" - インビジゴースト")+"&url="+encodeURIComponent("http://hakomo.github.io/invisible/")},t.prototype.update=function(t){var e,i,n,o;if(0===this.state){if(t.zJustDown||t.xJustDwon)return n=this.game.add.tween(this.ending).to({x:-140},700,Phaser.Easing.Default,!0),n.onComplete.addOnce(function(){return this.root.state.set(this)},this),this.state=1,this.root.state.set(null),this.game.sound.play("ok",this.root.option.sound/100)}else if(1===this.state){if(t.zJustDown||t.xJustDwon)return this.container.visible=!0,n=this.game.add.tween(this.ending).to({alpha:0},1e3,Phaser.Easing.Default,!0),n.onComplete.addOnce(function(){return this.root.state.set(this),this.ending.destroy()},this),this.state=2,this.root.state.set(null),this.game.sound.play("ok",this.root.option.sound/100)}else if(2===this.state){if(o=t.downJustDown-t.upJustDown)return this.index=__modulo(this.index+o,3),this.draw(),this.game.sound.play("ok",this.root.option.sound/100);if(t.zJustDown){if(0===this.index)return $("#tweet").hide(),this.container.destroy(),this.root.state.set(null),new Title(this.root,!0),this.game.sound.play("ok",this.root.option.sound/100);if(1===this.index)return this.game.sound.play("ok",this.root.option.sound/100),$("#tweet").hide(),this.container.destroy(),this.root.state.set(null),this.root.init();if(2===this.index)return e=document.createElement("a"),e.download=this.name,e.href=this.game.canvas.toDataURL(),i=document.createEvent("MouseEvents"),i.initEvent("click",!1,!0),e.dispatchEvent(i),this.game.sound.play("ok",this.root.option.sound/100)}}},t}();
var GameHeight,GameWidth,LineHeight,Root,SquareHeight,SquareLine,SquareRow,SquareSize,SquareWidth,SquareX,SquareY;GameWidth=640,GameHeight=480,SquareSize=64,SquareRow=8,SquareLine=3,SquareWidth=SquareSize*SquareRow,SquareHeight=SquareSize*SquareLine,SquareX=SquareSize/4,SquareY=(GameHeight-SquareHeight)/2,LineHeight=32,Root=function(){function i(i,e){this.game=i,this.state=e,this.game.add.image(0,0,"background"),this.skills=new Skills(this),this.hp=new Hp(this),this.turn=new Turn(this),this.timer=new Timer(this),this.squares=new Squares(this),this.notices=this.game.add.group(),this.notices.createMultiple(SquareRow*SquareLine,"notice"),this.notices.callAll("anchor.set","anchor",.5,.5),this.selection=new Selection(this),this.tips=new Tips(this),this.option=new Option(this),new Title(this,!1)}return i.prototype.init=function(){var i;return this.skills.init(),this.hp.init(),this.turn.init(),this.timer.init(),this.squares.init(),i=this.game.time.create(),i.add(500,this.skills.begin,this.skills),i.start()},i}();
var Selection,__modulo=function(t,i){return(+t%(i=+i)+i)%i};Selection=function(){function t(t){var i,e;this.root=t,this.game=this.root.game,this.Width=200,this.container=this.game.add.graphics((GameWidth-this.Width)/2,0),this.container.visible=!1,this.selected=this.game.add.graphics().beginFill(0,.3).lineStyle(1,0).drawRect(0,0,this.Width-1,LineHeight-1),this.container.addChild(this.selected),this.game.add.tween(this.selected).to({alpha:.4},750,Phaser.Easing.Default,!0,0,-1,!0),this.texts=function(){var t,s;for(s=[],i=t=0;3>t;i=++t)e=this.game.add.text(8,(i+.5)*LineHeight+11,"",{fill:"#fff",font:"18px Gennokaku"}),e.anchor.y=.5,this.container.addChild(e),s.push(e);return s}.call(this)}return t.prototype.draw=function(){return this.selected.y=(this.index+1)*LineHeight+8},t.prototype.begin=function(t){var i,e,s,n,h,o;for(this.ss=t,this.index=0,this.game.sound.play("ok",this.root.option.sound/100),this.container.visible=!0,this.container.alpha=.5,this.container.y=(GameHeight-this.ss.length*LineHeight)/2-4,this.container.clear().beginFill(Color.number(.5,.2,.5)).lineStyle(2,Color.number(.5,.2,.2)).drawRect(0,0,this.Width,this.ss.length*LineHeight+16),s=this.game.add.tween(this.container).to({alpha:1,y:this.container.y-4},100,Phaser.Easing.Default,!0),o=this.texts,i=n=0,h=o.length;h>n;i=++n)e=o[i],e.text=i<this.ss.length?this.ss[i].name:"";return this.draw(),this.root.state.set(this)},t.prototype.end=function(){return this.container.visible=!1,this.root.state.set(null)},t.prototype.update=function(t){var i;return i=t.downJustDown-t.upJustDown,i?(this.index=__modulo(this.index+i,this.ss.length-1),this.draw(),this.game.sound.play("ok",this.root.option.sound/100)):t.xJustDown?this.ss[0].callback.call(this.ss[0].context):t.zJustDown?this.ss[this.index+1].callback.call(this.ss[this.index+1].context):void 0},t}();
var Skill,__modulo=function(t,i){return(+t%(i=+i)+i)%i};Skill=function(){function t(t,i,e,n,o,s,r){var h;this.root=t,this.width=i,this.height=e,this.power=n,this.recovery=o,this.icon=s,this.effect=r,this.game=this.root.game,this.container=this.game.add.text(GameWidth/2,LineHeight/2+3,this.icon.children[1].text+"      "+this.power+" ダメ      +"+this.recovery+"% / Turn",{fill:"#fff",font:"18px Gennokaku"}),this.container.anchor.y=.5,h=this.game.add.graphics(0,SquareY-LineHeight/2-2).beginFill(Color.number(.3-.15*this.power,.5,.5),.5).drawRect(0,SquareSize*(SquareLine-this.height),SquareSize*this.width-1,SquareSize*this.height-1),this.container.addChild(h),this.game.add.tween(h).to({alpha:.4},750,Phaser.Easing.Default,!0,0,-1,!0)}return t.prototype.init=function(){return this.percent=100*Math.ceil(this.recovery/20),this.unselect(),this.draw()},t.prototype.draw=function(){return this.icon.children[0].text=this.percent+"%",this.icon.children[0].fill=this.canUse()?Color.string(.3,1,.7):"#fff",this.container.children[0].x=this.index*SquareSize+SquareX-LineHeight/2-GameWidth/2+17},t.prototype.show=function(){return this.container.visible=!0},t.prototype.hide=function(){return this.container.visible=!1},t.prototype.select=function(){return this.index=0,this.icon.x=GameWidth-3*SquareSize/2+1,this.show(),this.draw()},t.prototype.unselect=function(){return this.icon.x=GameWidth-5*SquareSize/4+1,this.hide()},t.prototype.canUse=function(){return this.percent>=100},t.prototype.use=function(){var t;if(this.canUse())return this.root.notices.callAllExists("kill",!0),this.root.skills.pause(),this.percent-=100,this.draw(),this.power?this.game.sound.play("attack",.4*this.root.option.sound/100):this.game.sound.play("search",this.root.option.sound/100),this.effect.begin(this.index),t=this.game.time.create(),t.add(350,function(){return this.root.squares.damage(this)},this),t.add(850,function(){return this.root.skills.resume(),this.root.hp.chara.position.set(0,0)},this),t.start()},t.prototype.turn=function(){return this.percent+=this.recovery,this.draw()},t.prototype.update=function(t){var i;return i=t.rightJustDown-t.leftJustDown,i?(this.index=__modulo(this.index+i,SquareRow-this.width+1),this.draw(),this.game.sound.play("ok",this.root.option.sound/100)):t.zJustDown?this.canUse()?this.use():this.game.sound.play("ng",.8*this.root.option.sound/100):void 0},t}();
var Skills,__modulo=function(t,e){return(+t%(e=+e)+e)%e};Skills=function(){function t(t){var e,s,i,n,o,r,h,a,l;this.root=t,this.game=this.root.game,this.skills=function(){var t,u,d,c,p;for(d=[[1,3,0,28,"列探",new Effect1(this.root)],[8,3,0,6,"全探",new Effect2(this.root)],[1,1,1,138,"単撃",new Effect3(this.root)],[2,2,1,44,"広撃",new Effect4(this.root)],[1,3,2,28,"強撃",new Effect5(this.root)]],p=[],i=t=0,u=d.length;u>t;i=++t)c=d[i],l=c[0],s=c[1],r=c[2],h=c[3],o=c[4],e=c[5],n=this.game.add.graphics(0,i*SquareSize+(GameHeight-5*SquareSize)/2),a=this.game.add.text(54,34,"",{font:"18px Gennokaku"}),a.anchor.x=1,n.addChild(a),a=this.game.add.text(SquareSize/2-1,6,o,{fill:"#fff",font:"24px Gennokaku"}),a.anchor.x=.5,n.addChild(a),p.push(new Skill(this.root,l,s,r,h,n,e));return p}.call(this),this.selected=this.game.add.graphics(GameWidth-SquareSize,0).lineStyle(4,16777215,.5).drawRect(-9*SquareSize/16,-9*SquareSize/16,9*SquareSize/8,9*SquareSize/8),this.selected.visible=!1,this.game.add.tween(this.selected).to({angle:360},6e3,Phaser.Easing.Default,!0,0,-1),this.ss=[{name:"ターンを進める？",callback:function(){return this.root.state.end(),this.root.skills.resume(),this.game.sound.play("ok",this.root.option.sound/100)},context:this},{name:"うん",callback:function(){return this.state.end(),this.skills.end(),this.squares.turn1()},context:this.root},{name:"やだ",callback:function(){return this.root.state.end(),this.root.skills.resume(),this.game.sound.play("ok",this.root.option.sound/100)},context:this}]}return t.prototype.init=function(){var t,e,s,i,n;for(i=this.skills,n=[],e=0,s=i.length;s>e;e++)t=i[e],n.push(t.init());return n},t.prototype.draw=function(){var t,e,s,i,n,o;for(this.selected.y=(this.index+.5)*SquareSize+(GameHeight-SquareSize*this.skills.length)/2,n=this.skills,o=[],t=s=0,i=n.length;i>s;t=++s)e=n[t],o.push(t===this.index?e.select():e.unselect());return o},t.prototype.resume=function(){return this.selected.visible=!0,this.skills[this.index].show(),this.root.state.set(this)},t.prototype.pause=function(){return this.selected.visible=!1,this.skills[this.index].hide(),this.root.state.set(null)},t.prototype.begin=function(){return this.index=0,this.draw(),this.resume(),this.game.sound.play("end",.2*this.root.option.sound/100)},t.prototype.end=function(){return this.skills[this.index].unselect(),this.pause()},t.prototype.turn=function(){var t,e,s,i;for(this.root.hp.heal(),i=this.skills,e=0,s=i.length;s>e;e++)t=i[e],t.turn();return this.begin()},t.prototype.update=function(t){var e;return e=t.downJustDown-t.upJustDown,e?(this.index=__modulo(this.index+e,this.skills.length),this.draw(),this.game.sound.play("ok",this.root.option.sound/100)):t.xJustDown?(this.pause(),this.root.selection.begin(this.ss)):this.skills[this.index].update(t)},t}();
var Square;Square=function(){function i(i,t){this.root=i,this.game=this.root.game,this.None=0,this.Enemy=1,this.Length=2,this.position=new Phaser.Point(t)}return i.prototype.init=function(i){return this.reset(),this.position.y=i},i.prototype.draw=function(i){var t,e;return i.children[0].lineStyle(1,16777215).drawRect(this.position.x*SquareSize,this.position.y*SquareSize,SquareSize,SquareSize),this.kind===this.Enemy&&this.hp?(this.attacked=!1,t=i.children[1].getFirstExists(!1),t.angle=0,t.frame=Math.floor((this.power-10)/30),t.owner=this,t.reset((this.position.x+.5)*SquareSize,(this.position.y+.625)*SquareSize),e=i.children.slice(2).reduce(function(i,t){return i.visible?t:i}),e.visible=!0,e.position.set((this.position.x+.8)*SquareSize,(this.position.y+.2)*SquareSize+3),e.text=this.power.toString()):void 0},i.prototype.reset=function(){return this.position.y=-1,this.found=!1,this.fazzyX=this.position.x+this.game.rnd.normal()/16,this.kind=this.game.rnd.frac()<.33|0,this.kind===this.None?this.hp=this.power=0:this.kind===this.Enemy?(this.hp=2,this.power=this.game.rnd.between(10,99)):void 0},i.prototype.notice=function(i){var t;return t=this.root.notices.getFirstExists(!1),t.frame=i,t.reset((this.position.x+.3)*SquareSize+SquareX,(this.position.y+.15)*SquareSize+SquareY)},i.prototype.damage=function(i){var t;if(0<=(t=this.position.x-i.index)&&t<i.width&&SquareLine-i.height<=this.position.y)return this.kind===this.Enemy&&this.hp&&(this.hp=Math.max(0,this.hp-i.power),this.hp?i.power?this.notice(1):this.found||this.notice(0):this.notice(2)),this.found=!0},i.prototype.turn=function(){return this.position.y+=1,this.position.y===SquareLine?this.reset():void 0},i}();
var Squares;Squares=function(){function e(e){var t,r,i,n,a,o,s,u,h,l,d,f,c,q,S;for(this.root=e,this.game=this.root.game,this.squares={},u=l=-1;-1<=SquareLine?l<SquareLine:l>SquareLine;u=-1<=SquareLine?++l:--l)this.squares[u]=function(){var e,t;for(t=[],s=e=0;0<=SquareRow?e<SquareRow:e>SquareRow;s=0<=SquareRow?++e:--e)t.push(new Square(this.root,s));return t}.call(this);for(this.container=this.game.add.sprite(SquareX,SquareY),this.buffer=this.game.add.sprite(SquareX,SquareY),this.buffer.alpha=0,S=[this.container,this.buffer],d=0,q=S.length;q>d;d++)for(t=S[d],h=f=-1;-1<=SquareLine?f<SquareLine:f>SquareLine;h=-1<=SquareLine?++f:--f)for(a=this.game.add.sprite(),t.addChild(a),r=this.game.add.graphics(),a.addChild(r),i=this.game.add.group(a),i.enableBody=!0,i.createMultiple(SquareRow,"enemy"),i.setAll("checkWorldBounds",!0),i.setAll("outOfBoundsKill",!0),i.callAll("anchor.set","anchor",.5,.5),i.callAll("events.onOutOfBounds.add","events.onOutOfBounds",function(e){return 1===e.parent.countLiving()?e.owner.root.squares.turn2():void 0}),n=c=0;0<=SquareRow?c<SquareRow:c>SquareRow;n=0<=SquareRow?++c:--c)o=this.game.add.text(0,0,"",{fill:"#fff",font:"18px Gennokaku"}),o.anchor.set(.5,.5),a.addChild(o)}return e.prototype.init=function(){var e,t,r,i,n,a;a=this.squares;for(r in a)for(e=a[r],i=0,n=e.length;n>i;i++)t=e[i],t.init(0|r);return this.draw()},e.prototype.draw=function(e){var t,r,i,n,a,o,s,u,h,l,d,f,c,q,S;null==e&&(e=!0),e&&(o=this.buffer,this.buffer=this.container,this.container=o,this.game.add.tween(this.container).to({alpha:1},500,Phaser.Easing.Default,!0),this.game.add.tween(this.buffer).to({alpha:0},500,Phaser.Easing.Default,!0)),c=this.squares,S=[];for(u in c){for(r=c[u],u|=0,i=this.container.children[u+1],i.alpha=u>-1|0,q=i.children.slice(2),h=0,d=q.length;d>h;h++)a=q[h],a.visible=!1;for(i.children[0].clear(),i.children[1].callAll("kill"),t=0,s=l=0,f=r.length;f>l;s=++l)n=r[s],n.found&&(this.drawLine(i,r.slice(t,s)),n.draw(i),t=s+1);S.push(this.drawLine(i,r.slice(t,SquareRow)))}return S},e.prototype.drawLine=function(e,t){var r,i,n,a;if(t.length){if(1===t.length)return t[0].kind===t[0].Enemy&&t[0].hp&&!t[0].found&&t[0].notice(0),t[0].found=!0,void t[0].draw(e);if(e.children[0].lineStyle(1,16777215).drawRect(t[0].position.x*SquareSize,t[0].position.y*SquareSize,t.length*SquareSize,SquareSize),r=t.reduce(function(e,t){return e+t.power},0))return n=(t.reduce(function(e,t){return e+t.fazzyX*t.power/r},0)+.5)*SquareSize,a=(t[0].position.y+.5)*SquareSize+3,i=e.children.slice(2).reduce(function(e,t){return e.visible?t:e}),i.visible=!0,i.position.set(n,a),i.text=r.toString()}},e.prototype.damage=function(e){var t,r,i,n,a,o;o=this.squares;for(i in o)for(t=o[i],n=0,a=t.length;a>n;n++)r=t[n],r.damage(e);return this.draw()},e.prototype.turn1=function(){var e,t,r,i,n;for(this.root.notices.callAllExists("kill",!0),this.game.sound.play("turn",this.root.option.sound/100),n=this.squares[SquareLine-1],r=0,i=n.length;i>r;r++)e=n[r],e.found=!0;return this.draw(),this.game.add.tween(this.container.children[0]).to({alpha:1},500,Phaser.Easing.Default,!0),this.game.add.tween(this.container).to({y:this.container.y+SquareSize},500,Phaser.Easing.Default,!0),t=this.game.add.tween(this.buffer).to({y:this.buffer.y+SquareSize},500,Phaser.Easing.Default,!0),this.root.turn.sunrise(),t.onComplete.addOnce(function(){var e,t,r,i,n,a,o,s;if(e=this.container.children[this.container.children.length-1],i=e.children[1].filter(function(){return!0},!0),i.total){for(o=function(){s=[];for(var e=0,t=i.total;t>=0?t>e:e>t;t>=0?e++:e--)s.push(e);return s}.apply(this).map(function(e){return 300*e}),n=0,a=o.length;a>n;n++)t=o[n],r=this.game.rnd.pick(i.list),i.remove(r),this.root.hp.damage(r,t);return this.root.hp.begin(e.children[1])}return this.turn2()},this)},e.prototype.turn2=function(){var e;return e=this.game.add.tween(this.container.children[this.container.children.length-1]).to({alpha:0},500,Phaser.Easing.Default,!0),e.onComplete.addOnce(function(){var e,t,r,i,n,a,o,s,u,h;u=this.squares;for(n in u)for(e=u[n],a=0,s=e.length;s>a;a++)t=e[a],t.turn();for(r=this.squares[SquareLine-1],i=o=h=SquareLine-1;0>=h?0>=o:o>=0;i=0>=h?++o:--o)this.squares[i]=this.squares[i-1];return this.squares[-1]=r,this.container.y-=SquareSize,this.buffer.y-=SquareSize,this.draw(!1),this.root.turn.turn()},this)},e}();
var State;State=function(){function t(){new Phaser.Game(GameWidth,GameHeight,Phaser.CANVAS,"game",this),this.set(null)}return t.prototype.preload=function(){return this.game.load.image("background","images/background.png").spritesheet("chara","images/Actor130.png",32,32,12).spritesheet("enemy","images/enemy.png",32,32,3,0,1).spritesheet("notice","images/notice.png",46,26,3,0,1).audio("attack","sounds/hit_s06_r.mp3").audio("bird","sounds/bird.mp3").audio("damage","sounds/tm2_hit001.mp3").audio("end","sounds/power21.mp3").audio("ng","sounds/push11.mp3").audio("ok","sounds/type00.mp3").audio("over","sounds/warp03r.mp3").audio("search","sounds/tm2_coin000.mp3").audio("turn","sounds/tm2_shake001.mp3")},t.prototype.create=function(){return this.keys=new Keys(this.game.input.keyboard),this.root=new Root(this.game,this)},t.prototype.update=function(){var t;return this.keys.update(),this.root.timer.update(this.keys),null!=(t=this.current)?t.update(this.keys):void 0},t.prototype.set=function(t){return this.current=t},t.prototype.end=function(){var t;return null!=(t=this.current)?t.end():void 0},t}();
var Timer;Timer=function(){function t(t){this.root=t,this.game=this.root.game,this.isRunning=!1,this.text=this.game.add.text(15*GameWidth/16,3*GameHeight/4+SquareSize*(SquareLine+2)/4+3,"",{fill:"#fff",font:"18px Gennokaku"}),this.text.anchor.set(1,.5)}return t.prototype.draw=function(t){var i;return i=Math.floor((t-this.begin+999)/1e3),this.text.text=Math.floor(i/60)+" 分 "+("0"+i%60).slice(-2)+" 秒"},t.prototype.init=function(){return this.text.visible=this.root.option.timer,this.isRunning=!0,this.begin=(new Date).getTime()+500,this.draw(this.begin)},t.prototype.stop=function(t){return this.text.visible=t,this.isRunning=!1,this.end=(new Date).getTime(),this.draw(this.end)},t.prototype.update=function(){return this.isRunning&&this.text.visible?this.draw((new Date).getTime()):void 0},t}();
var Tips;Tips=function(){function t(t){var i;this.root=t,this.game=this.root.game,this.play=localStorage.getItem("play"),null==this.play&&(this.play=0),this.play|=0,this.tips=function(){var t,e,n,a;for(n=["1 回 遊ぶたびに TIPS が 1 つ解放される。","赤 > 紫 > 青 の順に霊力が強い。","毎ターン HP は 10 回復する。","重心にはわずかに誤差がある。","ゴーストは 3 マスに 1 体の確率で出現する。","霊力は 10 から 99 まで。","スキルを使える回数は決まっている。","COMPLETE TIPS ! もうクリアはできたかな？"],a=[],t=0,e=n.length;e>t;t++)i=n[t],a.push(i.split("\n"));return a}()}return t.prototype.increment=function(){return++this.play,localStorage.setItem("play",this.play),this.tips[this.play%this.tips.length]},t.prototype.begin=function(t,i){var e,n,a,s,o,h,r,l,d,p,u;for(this.background=this.game.add.sprite(0,0,"background"),this.background.visible=!1,this.container=this.game.add.sprite(0,GameHeight),s=this.game.add.text(3*GameWidth/16,40,"TIPS      "+Math.min(this.tips.length,this.play+1)+" / "+this.tips.length,{fill:"#fff",font:"32px Gennokaku"}),this.container.addChild(s),u=this.tips,e=r=0,d=u.length;d>r;e=++r)for(o=u[e],s=this.game.add.text(3*GameWidth/16,(e+2.5)*LineHeight*1.25,(e+1).toString(),{fill:Color.string(.3,1,.7),font:"18px Gennokaku"}),this.container.addChild(s),e>this.play&&(o=["?"]),n=l=0,p=o.length;p>l;n=++l)a=o[n],s=this.game.add.text(3*GameWidth/16+24,(e+2.5)*LineHeight*1.25+24*n,a,{fill:"#fff",font:"18px Gennokaku"}),this.container.addChild(s);return this.root.state.set(this),h=this.game.add.tween(this.container).to({y:0},1e3,Phaser.Easing.Back.Out,!0),h.onComplete.addOnce(function(){return this.background.visible=!0,t.call(i)},this)},t.prototype.update=function(t){var i;return t.zJustDown||t.xJustDown?(i=this.game.add.tween(this.container).to({y:GameHeight},1e3,Phaser.Easing.Back.Out,!0),i.onComplete.addOnce(function(){return this.background.destroy(),this.container.destroy(),this.background=null,this.container=null},this),this.root.state.set(null),new Title(this.root,!0,1),this.game.sound.play("ok",this.root.option.sound/100)):void 0},t}();
var Title,__modulo=function(t,e){return(+t%(e=+e)+e)%e};Title=function(){function t(t,e,i){var a,n,s,h,o,d,r,l,g,u,m,c,f,p,y,k;for(this.root=t,this.zDown=e,this.index=null!=i?i:0,this.game=this.root.game,this.background=this.game.add.sprite(0,0,"background"),d=this.game.add.group(this.background),d.enableBody=!0,d.createMultiple(20,"enemy"),d.setAll("checkWorldBounds",!0),d.setAll("outOfBoundsKill",!0),d.callAll("anchor.set","anchor",.5,.5),d.callAll("events.onOutOfBounds.add","events.onOutOfBounds",function(t){return t.tween.stop()}),this.timer=this.game.time.create(),this.timer.loop(1700,function(){var t,e;return t=this.background.children[0].getFirstExists(!1),t.reset(this.game.rnd.between(16,GameWidth-17),this.game.rnd.between(16,GameHeight-17)),t.alpha=0,t.frame=this.game.rnd.between(0,2),t.tween=this.game.add.tween(t).to({alpha:1},2900,Phaser.Easing.Default,!0,0,-1,!0),e=this.game.rnd.normal()*Math.PI,t.body.velocity.set(Math.cos(e),Math.sin(e)),t.body.velocity.setMagnitude(40)},this),this.container=this.game.add.sprite(),u=this.game.add.text(GameWidth-16,8,"(C) 2015 hakomo / てくてくぺたぺた",{fill:"#fff",font:"18px Gennokaku"}),u.anchor.x=1,this.container.addChild(u),u=this.game.add.text(GameWidth/2,GameHeight/2+3,"インビジ ゴースト",{fill:"#fff",font:"48px Gennokaku"}),u.anchor.set(.5,.5),this.container.addChild(u),u=this.game.add.text(16,8,"v1.0 2015/06/18",{fill:"#fff",font:"18px Gennokaku"}),this.container.addChild(u),n=this.game.add.image(198,190,"enemy",1),n.angle=40,this.container.addChild(n),s=this.game.add.image(308,274,"enemy",0),s.angle=260,this.container.addChild(s),h=this.game.add.image(382,202,"enemy",2),this.container.addChild(h),this.enemy3=[n,s,h],this.pre=this.game.add.text(GameWidth/2,5*GameHeight/8+3,"Z キーを押してね（音が出るよ）",{fill:"#fff",font:"18px Gennokaku"}),this.pre.anchor.set(.5,.5),this.container.addChild(this.pre),this.selected=this.game.add.graphics(5*GameWidth/8).beginFill(16777215,.3).lineStyle(1,16777215).drawRect(0,0,199,LineHeight-1),this.container.addChild(this.selected),this.game.add.tween(this.selected).to({alpha:.4},750,Phaser.Easing.Default,!0,0,-1,!0),y=["GAME START","TIPS","OPTION"],r=m=0,f=y.length;f>m;r=++m)l=y[r],u=this.game.add.text(5*GameWidth/8+8,(r+.5)*LineHeight+5*GameHeight/8+3-(64-GameHeight/2),l,{fill:"#fff",font:"18px Gennokaku"}),u.anchor.y=.5,this.container.addChild(u);if(this.draw(),this.zDown){for(this.pre.alpha=0,k=this.enemy3,c=0,p=k.length;p>c;c++)a=k[c],a.alpha=0;this.index?(this.background.visible=!1,this.container.y=64-1.5*GameHeight,g=this.game.add.tween(this.container).to({y:64-GameHeight/2},1e3,Phaser.Easing.Back.Out,!0),g.onComplete.addOnce(function(){return this.background.visible=!0,this.timer.start(),this.root.state.set(this)},this)):(this.background.alpha=0,o=this.game.add.tween(this.background).to({alpha:1},200,Phaser.Easing.Default,!0),this.container.y=64-1.5*GameHeight,g=this.game.add.tween(this.container).to({y:64-GameHeight/2},1e3,Phaser.Easing.Back.Out),o.chain(g),g.onComplete.addOnce(function(){return this.timer.start(),this.root.state.set(this)},this))}else this.root.state.set(this)}return t.prototype.draw=function(){return this.selected.y=this.index*LineHeight+5*GameHeight/8-(64-GameHeight/2)},t.prototype.update=function(t){var e,i,a,n,s,h,o,d;if(this.zDown){if(s=t.downJustDown-t.upJustDown)return this.index=__modulo(this.index+s,3),this.draw(),this.game.sound.play("ok",this.root.option.sound/100);if(t.zJustDown){if(0===this.index)return this.game.sound.play("ok",this.root.option.sound/100),i=this.game.add.tween(this.container).to({y:64-1.5*GameHeight},700,Phaser.Easing.Quadratic.Out,!0),n=this.game.add.tween(this.background).to({alpha:0},500,Phaser.Easing.Default),i.chain(n),i.onComplete.addOnce(function(){return this.index?void 0:this.root.init()},this),this.timer.destroy(),n.onComplete.addOnce(function(){return this.background.destroy(),this.container.destroy()},this),this.root.state.set(null);if(1===this.index)return i=this.game.add.tween(this.container).to({y:64-1.5*GameHeight},700,Phaser.Easing.Quadratic.Out,!0),this.timer.destroy(),this.root.state.set(null),this.root.tips.begin(function(){return this.background.destroy(),this.container.destroy()},this),this.game.sound.play("ok",this.root.option.sound/100);if(2===this.index)return this.selected.visible=!1,this.root.state.set(null),this.root.option.begin(this),this.game.sound.play("ok",this.root.option.sound/100)}}else if(t.zJustDown){for(this.game.add.tween(this.container).to({y:64-GameHeight/2},500,Phaser.Easing.Quadratic.Out,!0),this.game.add.tween(this.pre).to({alpha:0},500,Phaser.Easing.Default,!0),d=this.enemy3,a=h=0,o=d.length;o>h;a=++h)e=d[a],this.game.add.tween(e).to({alpha:0},500,Phaser.Easing.Default,!0);return this.timer.start(),this.zDown=!0}},t}();
var Turn;Turn=function(){function t(t){this.root=t,this.game=this.root.game,this.text=this.game.add.text(3*GameWidth/4,3*GameHeight/4+SquareSize*(SquareLine+2)/4+3,"",{fill:"#fff",font:"18px Gennokaku"}),this.text.anchor.set(1,.5),this.yoake=this.game.add.text(3*GameWidth/4-26,3*GameHeight/4+SquareSize*(SquareLine+2)/4+3-20,"夜明けまであと",{fill:"#fff",font:"18px Gennokaku"}),this.yoake.anchor.set(.5,.5)}return t.prototype.init=function(){return this.t=28,this.draw(),this.game.world.children[0].alpha=1,this.yoake.visible=!1},t.prototype.draw=function(){return this.text.text=this.t+" Turn"},t.prototype.sunrise=function(){return 2===this.t?(this.game.stage.backgroundColor=Color.number(.6,.2,.5),this.game.add.tween(this.game.world.children[0]).to({alpha:.8},500,Phaser.Easing.Default,!0)):1===this.t?(this.game.stage.backgroundColor=Color.number(.6,.4,.5),this.game.add.tween(this.game.world.children[0]).to({alpha:.7},500,Phaser.Easing.Default,!0)):void 0},t.prototype.turn=function(){return--this.t,this.draw(),2===this.t&&(this.yoake.visible=!0),this.root.hp.hp.isMin()?new Result(this.root,!1):this.t?this.root.skills.turn():new Result(this.root,!0)},t}();
WebFontConfig.active=function(){return new State};