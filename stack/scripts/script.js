var Color;Color={number:function(r,o,n){var t;return t=Phaser.Color.HSLtoRGB(r,o,n),t.r<<16|t.g<<8|t.b},string:function(r,o,n){var t;return t=Phaser.Color.HSLtoRGB(r,o,n),Phaser.Color.RGBtoString(t.r,t.g,t.b)}};
var Text,extend=function(t,e){function n(){this.constructor=t}for(var r in e)hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;Text=function(t){function e(t,n,r,o,i){e.__super__.constructor.call(this,t,n,r,null!=o?o.toString():void 0,i),this.updateAnchor(),this.y=this.my(r)}return extend(e,t),e.prototype.setStyle=function(t){return t||(t={}),t.fill||(t.fill="white"),t.font||(t.font="18px Gennokaku"),t.lineHeight||(t.lineHeight=32),e.__super__.setStyle.call(this,t),this.updateAnchor()},e.prototype.my=function(t){return Math.round(t+3+(this.style.lineHeight-this.determineFontProperties(this.style.font).fontSize-this.style.strokeThickness)*(.5-this.anchor.y))},e.prototype.updateText=function(){return this.lineSpacing=this.style.lineHeight-this.determineFontProperties(this.style.font).fontSize-this.style.strokeThickness,e.__super__.updateText.apply(this,arguments)},e.prototype.updateAnchor=function(){var t;return null!=(t=this.anchor)?t.set(this.style.anchorX||0,this.style.anchorY||0):void 0},e}(Phaser.Text),Text.Center={align:"center",anchorX:.5},Text.Right={align:"right",anchorX:1},Phaser.GameObjectFactory.prototype.yatext=function(t,e,n,r,o){return(null!=o?o:this.world).add(new Text(this.game,t,e,n,r))},Phaser.GameObjectCreator.prototype.yatext=function(t,e,n,r){return new Text(this.game,t,e,n,r)};
var Util;Util={jump:function(t,e,n,i,o){var y,l,r,d,u,a,c,s;return null==i&&(i=700),null==o&&(o=.002),t.body&&(l=t.body.gravity.clone(),a=t.body.velocity.clone(),t.body.gravity.set(0,0),t.body.velocity.set(0,0)),y=t.game.add.tween(t).to({x:e},i,void 0,!0),y.onComplete.addOnce(function(t){return t.body?(t.body.gravity.set(l.x,l.y),t.body.velocity.set(a.x,a.y)):void 0}),c=t.y,u=(n-c-i*i*o/2)/i,d=-u/o,s=u*d+d*d*o/2+c,r=t.game.add.tween(t).to({y:s},d,function(t){return t*d*(t*d*o/2+u)/(s-c)},!0),r.chain(t.game.add.tween(t).to({y:n},i-d,function(t){return t*t*(i-d)*(i-d)*o/(n-s)/2})),y},shake:function(t,e,n,i,o){var y;return null==e&&(e=6),null==n&&(n=0),null==i&&(i=6),null==o&&(o=50),y=t.game.time.create(),y.loop(o,function(o,l){return this.i?(e?t.x=o+e*this.i*(this.i%2*2-1)/i:n&&(t.y=l+n*this.i*(this.i%2*2-1)/i),--this.i):(e?t.x=o:n&&(t.y=l),y.destroy())},{i:i},t.x,t.y),y.start()}};
var ColorN,LineWidth,RadiusMax,RadiusMin,RadiusN,RadiusStep,Root;ColorN=3,LineWidth=8,RadiusMin=24,RadiusMax=48,RadiusStep=8,RadiusN=Math.floor((RadiusMax-RadiusMin)/RadiusStep)+1,Root=function(){function t(){new Phaser.Game(640,480,Phaser.AUTO,"game",this)}return t.prototype.preload=function(){return this.game.load.image("floor","images/floor.png").spritesheet("image","images/image.png",128,128)},t.prototype.create=function(){return this.game.physics.startSystem(Phaser.Physics.P2JS),this.game.stage.backgroundColor=Color.number(0,0,.2),this.game.world.setBounds(-128,-128,this.game.width+256,this.game.height+256),this.game.input.mouse.callbackContext=this,this.game.input.mouse.mouseDownCallback=this.onDown,this.game.input.mouse.mouseWheelCallback=this.onWheel,this.game.input.mspointer.callbackContext=this,this.game.input.mspointer.pointerDownCallback=this.onDown,this.game.canvas.addEventListener("contextmenu",function(t){return t.preventDefault()}),this.game.canvas.addEventListener("wheel",function(t){return t.preventDefault()}),this.floor=this.game.add.sprite(this.game.width/2,15*this.game.height/16,"floor"),this.floor.collided=!0,this.game.physics.p2.enable(this.floor),this.floor.body.angle=3,this.floor.body["static"]=!0,this.falls=this.game.add.group(),this.falls.enableBody=!0,this.falls.createMultiple(90,"image"),this.falls.setAll("checkWorldBounds",!0),this.falls.setAll("outOfBoundsKill",!0),this.falls.callAll("anchor.set","anchor",.5,.5),this.falls.callAll("events.onOutOfBounds.add","events.onOutOfBounds",function(t){return this.falls.addChild(t)},this),this.stacks=this.game.add.group(),this.stacks.enableBody=!0,this.stacks.physicsBodyType=Phaser.Physics.P2JS,this.stacks.createMultiple(90,"image"),this.text=this.game.add.yatext(this.game.width-8,this.game.height/2-32,"",{align:"right",anchorX:1,font:"24px Gennokaku"}),this.text.visible=!1,this.retry=this.game.add.yatext(this.game.width-8,8,"スタート",{align:"right",anchorX:1,font:"24px Gennokaku"}),this.tweet=this.game.add.yatext(this.game.width-8,this.game.height-40,"ツイート",{align:"right",anchorX:1,font:"24px Gennokaku"}),this.tweet.visible=!1,this.stacks.forEach(function(t){return t.body.onBeginContact.add(function(t){return t?t.sprite.collided&&!this.sprite.collided?(this.sprite.collided=!0,++this.root.score,this.root.text.text=this.root.score+" 点\n確定",this.sprite.body.damping=.9):void 0:(this.sprite.collided&&(--this.root.score,this.root.text.text=this.root.score+" 点\n確定"),this.sprite.kill())},{root:this,sprite:t})},this)},t.prototype.start=function(){var t;return this.game.physics.p2.paused=!1,this.cursor=null,this.falls.callAll("kill"),this.stacks.callAll("kill"),this.score=0,this.text.text=this.score+" 点\n確定",this.tweet.visible=!1,this.appearLine(),null!=(t=this.timer)&&t.destroy(),this.timer=this.game.time.create(),this.timer.loop(9e3,this.appearLine,this),this.timer.start()},t.prototype.appearLine=function(){var t,i,e;for(i=[],e=t=0;4>=t;e=++t)i.push(this.appear(64*e+192,-32));return i},t.prototype.appear=function(t,i){var e;return(e=this.falls.getFirstExists(!1))?(e.reset(t,i),e.angle=this.game.rnd.angle(),e.frame=this.game.rnd.between(0,ColorN-1)+3*Math.floor((this.game.rnd.between(0,4)+1)/2)+this.game.rnd.between(0,RadiusN-1)*ColorN*3,e.body.gravity.y=0,e.body.velocity.set(0,6)):void 0},t.prototype.onDown=function(t){var i,e,s,o,a,r,h,l,n,d,u,c;if(this.cursor&&t.button===Phaser.Mouse.LEFT_BUTTON){if(c=this.stacks.getFirstExists(!1),!c)return;c.reset(this.cursor.x,this.cursor.y),c.angle=this.cursor.angle,c.collided=!1,c.frame=this.cursor.frame,c.body.angle=this.cursor.angle,c.body.damping=0,c.body.mass=this.cursor.frame%ColorN+1,c.body.force.y=8e3*c.body.mass,s=Math.floor(this.cursor.frame%(3*ColorN)/3)+2,o=Math.floor(this.cursor.frame/(3*ColorN))*RadiusStep+RadiusMin,c.body.clearShapes(),2===s?c.body.addRectangle(2*o,LineWidth):3===s?(i=o*Math.sqrt(3),c.body.addRectangle(i,LineWidth,o/4,o/Math.sqrt(3)-o/8,Math.PI/-6),c.body.addRectangle(LineWidth,i,o/-2)):4===s&&(i=o*Math.sqrt(2),c.body.addRectangle(i,LineWidth,0,i/-2),c.body.addRectangle(i,LineWidth,0,i/2),c.body.addRectangle(LineWidth,i+LineWidth,i/-2)),this.cursor.kill(),this.cursor=null}else this.cursor&&t.button===Phaser.Mouse.RIGHT_BUTTON&&(this.cursor.body.gravity.y=400,this.cursor.body.velocity.x=this.cursor.x<this.game.width/2?-400:400,this.game.world.addChild(this.cursor),this.cursor=null);if(t.button===Phaser.Mouse.LEFT_BUTTON)return e=this.game.input.mousePointer,532<=(a=e.x)&&640>a&&8<=(r=e.y)&&40>r?(Util.shake(this.retry),this.retry.text="リトライ",this.text.visible=!0,this.start()):576<=(h=e.x)&&640>h&&204<=(l=e.y)&&276>l&&this.text.visible?(Util.shake(this.text),this.game.physics.p2.paused=!0,this.falls.callAll("kill"),null!=(n=this.timer)&&n.destroy(),this.timer=null,this.tweet.visible=!0):530<=(d=e.x)&&640>d&&440<=(u=e.y)&&472>u&&this.tweet.visible?(Util.shake(this.tweet),window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent("何かを "+this.score+" 点積みました。")+"&url="+encodeURIComponent("http://hakomo.github.io/stack/"),"intent")):void 0},t.prototype.onWheel=function(){var t;return null!=(t=this.cursor)?t.angle-=18*this.game.input.mouse.wheelDelta:void 0},t.prototype.update=function(){var t,i,e,s,o,a,r,h,l;return this.cursor=null,i=900,this.falls.forEachExists(function(t){var e,s;return t.alpha=.5,s=this.game.input.mousePointer,e=this.game.math.distance(s.x,s.y,t.x,t.y),e<Math.floor(t.frame/(3*ColorN))*RadiusStep+RadiusMin&&i>e?(this.cursor=t,i=e):void 0},this),null!=(e=this.cursor)&&(e.alpha=1),this.stacks.forEachExists(function(t){return t.collided?t.body.force.y+=200*t.body.mass:void 0}),this.retry.fill="#fff",this.text.fill="#fff",this.tweet.fill="#fff",t=this.game.input.mousePointer,532<=(s=t.x)&&640>s&&8<=(o=t.y)&&40>o?this.retry.fill=Color.string(.3,1,.7):576<=(a=t.x)&&640>a&&204<=(r=t.y)&&276>r&&this.text.visible?this.text.fill=Color.string(.3,1,.7):530<=(h=t.x)&&640>h&&440<=(l=t.y)&&472>l&&this.tweet.visible?this.tweet.fill=Color.string(.3,1,.7):void 0},t}();
WebFontConfig.active=function(){return new Root};